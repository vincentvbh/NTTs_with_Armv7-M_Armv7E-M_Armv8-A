
#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <assert.h>

#include "NTT_params.h"

#include "tools.h"
#include "gen_table.h"

#define BUFF_MAX (NTT_N << 3)

struct compress_profile profile;

static const int32_t streamlined_CT_small_table_Q1[15] = {
1, 1, 1, 17388, -381964, -479647, -614878, 1001824, 17388, -614878, 1001824, 1035340, -442794, -644954, -679414
};

static const int32_t streamlined_CT_table_Q1[NTT_N - 1] = {
-381964, -381964, -381964, -479647, -381964, -479647, -614878, 1001824, -479647, -614878, 1001824, 1035340, -442794, -644954, -679414, -381964, -381964, -479647, -381964, -479647, -614878, 1001824, -381964, -479647, -614878, 1001824, 1035340, -442794, -644954, -679414, -479647, -614878, 1001824, 1035340, -442794, -644954, -679414, 880004, 891654, -622391, -356718, -660154, -166647, -189839, -173989, -614878, 1035340, -442794, 880004, 891654, -622391, -356718, -69492, -1041837, -717395, -870438, 155107, 939063, 379753, -433043, 1001824, -644954, -679414, -660154, -166647, -189839, -173989, -18864, -643235, 434648, -904201, 165246, 710, 368092, -937774, 1035340, 880004, 891654, -69492, -1041837, -717395, -870438, 755194, -778786, 912812, 34004, -592153, -28866, -422288, -1032703, -442794, -622391, -356718, 155107, 939063, 379753, -433043, 836191, 140375, -526346, -508179, -436191, -904031, -643204, 557892, -644954, -660154, -166647, -18864, -643235, 434648, -904201, -97034, -364303, -397598, 827212, 100581, -514091, 1022407, -128730, -679414, -189839, -173989, 165246, 710, 368092, -937774, -572555, 866435, -516601, 43080, -586603, 558968, 617077, -297790, 880004, -69492, -1041837, 755194, -778786, 912812, 34004, -528982, -470285, -883010, -1031957, -681128, 33616, 300500, -219226, 891654, -717395, -870438, -592153, -28866, -422288, -1032703, 700751, -788736, -192890, 988369, -369248, -396665, -746931, 582481, -622391, 155107, 939063, 836191, 140375, -526346, -508179, 298355, 15692, 223639, -115733, 425927, -331116, -354750, -605082, -356718, 379753, -433043, -436191, -904031, -643204, 557892, -936546, 133162, 245060, -884044, -434915, 431847, 238199, 753906, -660154, -18864, -643235, -97034, -364303, -397598, 827212, 233053, 935461, 403627, -251010, -114897, -283118, 782421, -678177, -166647, 434648, -904201, 100581, -514091, 1022407, -128730, -482951, -769721, -496058, 689073, -328961, -486965, 953761, 1028955, -189839, 165246, 710, -572555, 866435, -516601, 43080, 826414, -967300, -176390, 143671, -428141, -633738, -262749, -179501, -173989, 368092, -937774, -586603, 558968, 617077, -297790, 745345, 1031845, -486438, -933168, 705801, -554418, 978257, -484402
};

static const int32_t mul_Rmod_table_Q1[NTT_N >> 1] = {
-381964, -479647, -614878, 1001824, 1035340, -442794, -644954, -679414, 880004, 891654, -622391, -356718, -660154, -166647, -189839, -173989, -69492, -1041837, -717395, -870438, 155107, 939063, 379753, -433043, -18864, -643235, 434648, -904201, 165246, 710, 368092, -937774, 755194, -778786, 912812, 34004, -592153, -28866, -422288, -1032703, 836191, 140375, -526346, -508179, -436191, -904031, -643204, 557892, -97034, -364303, -397598, 827212, 100581, -514091, 1022407, -128730, -572555, 866435, -516601, 43080, -586603, 558968, 617077, -297790, -528982, -470285, -883010, -1031957, -681128, 33616, 300500, -219226, 700751, -788736, -192890, 988369, -369248, -396665, -746931, 582481, 298355, 15692, 223639, -115733, 425927, -331116, -354750, -605082, -936546, 133162, 245060, -884044, -434915, 431847, 238199, 753906, 233053, 935461, 403627, -251010, -114897, -283118, 782421, -678177, -482951, -769721, -496058, 689073, -328961, -486965, 953761, 1028955, 826414, -967300, -176390, 143671, -428141, -633738, -262749, -179501, 745345, 1031845, -486438, -933168, 705801, -554418, 978257, -484402
};

static const int32_t streamlined_inv_CT_table_Q1[NTT_N - 1] = {
-381964, -381964, 479647, -381964, -381964, 479647, -381964, 479647, -1001824, 614878, 479647, -1001824, 614878, 679414, 644954, 442794, -1035340, -1001824, 679414, 644954, 173989, 189839, 166647, 660154, 614878, 442794, -1035340, 356718, 622391, -891654, -880004, -381964, -381964, 479647, -381964, 479647, -1001824, 614878, 479647, -1001824, 614878, 679414, 644954, 442794, -1035340, -1001824, 679414, 644954, 173989, 189839, 166647, 660154, 614878, 442794, -1035340, 356718, 622391, -891654, -880004, 679414, 173989, 189839, 937774, -368092, -710, -165246, 644954, 166647, 660154, 904201, -434648, 643235, 18864, 442794, 356718, 622391, 433043, -379753, -939063, -155107, -1035340, -891654, -880004, 870438, 717395, 1041837, 69492, 173989, 937774, -368092, 297790, -617077, -558968, 586603, 189839, -710, -165246, -43080, 516601, -866435, 572555, 166647, 904201, -434648, 128730, -1022407, 514091, -100581, 660154, 643235, 18864, -827212, 397598, 364303, 97034, 356718, 433043, -379753, -557892, 643204, 904031, 436191, 622391, -939063, -155107, 508179, 526346, -140375, -836191, -891654, 870438, 717395, 1032703, 422288, 28866, 592153, -880004, 1041837, 69492, -34004, -912812, 778786, -755194, 937774, 297790, -617077, 484402, -978257, 554418, -705801, -368092, -558968, 586603, 933168, 486438, -1031845, -745345, -710, -43080, 516601, 179501, 262749, 633738, 428141, -165246, -866435, 572555, -143671, 176390, 967300, -826414, 904201, 128730, -1022407, -1028955, -953761, 486965, 328961, -434648, 514091, -100581, -689073, 496058, 769721, 482951, 643235, -827212, 397598, 678177, -782421, 283118, 114897, 18864, 364303, 97034, 251010, -403627, -935461, -233053, 433043, -557892, 643204, -753906, -238199, -431847, 434915, -379753, 904031, 436191, 884044, -245060, -133162, 936546, -939063, 508179, 526346, 605082, 354750, 331116, -425927, -155107, -140375, -836191, 115733, -223639, -15692, -298355, 870438, 1032703, 422288, -582481, 746931, 396665, 369248, 717395, 28866, 592153, -988369, 192890, 788736, -700751, 1041837, -34004, -912812, 219226, -300500, -33616, 681128, 69492, 778786, -755194, 1031957, 883010, 470285, 528982
};

int32_t final_const[4] = {
invNR2modQ1, invomega4RmodQ1
};


int main(){

// ================================

    int32_t mod_int32;
    int32_t scale_int32;
    int32_t omega_int32;

    int32_t buff[BUFF_MAX];

// ================================

    profile.compressed_layers = 3;
    profile.merged_layers[0] = 1;
    profile.merged_layers[1] = 3;
    profile.merged_layers[2] = 4;

    scale_int32 = 1;
    mod_int32 = Q1;
    omega_int32 = omegaQ1;
    gen_streamlined_CT_table_generic(
        buff,
        &scale_int32, &omega_int32,
        &mod_int32,
        sizeof(int32_t),
        mulmod_int32,
        &profile, 0
    );

    scale_int32 = RmodQ1;
    mod_int32 = Q1;
    for(size_t i = 4; i < 8; i++){
        mulmod_int32(buff + i, buff + i, &scale_int32, &mod_int32);
    }
    for(size_t i = 9; i < 15; i++){
        mulmod_int32(buff + i, buff + i, &scale_int32, &mod_int32);
    }

    for(size_t i = 0; i < 15; i++){
        assert(buff[i] == streamlined_CT_small_table_Q1[i]);
    }

    scale_int32 = RmodQ1;
    mod_int32 = Q1;
    omega_int32 = omegaQ1;
    gen_streamlined_CT_table_generic(
        buff,
        &scale_int32, &omega_int32,
        &mod_int32,
        sizeof(int32_t),
        mulmod_int32,
        &profile, 0
    );

    for(size_t i = 0; i < (NTT_N - 1); i++){
        assert(buff[i] == streamlined_CT_table_Q1[i]);
    }

// ================

    scale_int32 = RmodQ1;
    omega_int32 = omegaQ1;
    mod_int32 = Q1;
    gen_mul_table_generic(
        buff,
        &scale_int32, &omega_int32,
        &mod_int32,
        sizeof(int32_t),
        mulmod_int32
    );

    for(size_t i = 0; i < (NTT_N >> 1); i++){
        assert(buff[i] == mul_Rmod_table_Q1[i]);
    }

// ================

    profile.compressed_layers = 3;
    profile.merged_layers[0] = 2;
    profile.merged_layers[1] = 3;
    profile.merged_layers[2] = 3;

    scale_int32 = RmodQ1;
    mod_int32 = Q1;
    omega_int32 = invomegaQ1;
    gen_streamlined_CT_table_generic(
        buff,
        &scale_int32, &omega_int32,
        &mod_int32,
        sizeof(int32_t),
        mulmod_int32,
        &profile, 0
    );

    for(size_t i = 0; i < (NTT_N - 1); i++){
        assert(buff[i] == streamlined_inv_CT_table_Q1[i]);
    }

// ================================

    printf("Well done!\n");


}















